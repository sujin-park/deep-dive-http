# 18장 웹 호스팅

`웹 호스팅`이란 콘텐츠 리소스를 저장, 중개, 관리하는 일을 의미합니다. 콘텐츠를 저장해서 제공하고 관련 로그에 접근하거나 그것을 관리하는 데 서버가 필요한데, 필요한 하드웨어와 소프트웨어를 직접 관리하기 어렵다면 호스팅 서비스나 호스팅 업체가 필요할 것입니다.

## 18.1 호스팅 서비스

해당 장에서는 호스팅 웹 서버가 무엇을 제공하는지 정리를 할 예정이며, 웹 사이트가 동작하는 데 필요한 많은 기능은 웹 서버 호스팅의 지원 범위에 따라서 달라집니다.

## 18.2 가상 호스팅

`가상 호스팅 또는 공유 호스팅`은 많은 웹 호스팅 업자는 컴퓨터 한 대를 여러 고객이 공유하게 해서 저렴한 웹 호스팅 서비스를 제공하는 것을 의미합니다. 웹 사이트는 다른 서버에서 호스팅하는 것처럼 보이지만 물리적으로 같은 서버에서 호스팅 되는 것으로 최종 사용자의 관점에서는 구분할 수 없어야 합니다.

### 18.2.1 호스트 정보가 없는 가상 서버 요청

- HTTP/1.0 명세에는 공용 웹 서버가 호스팅하고 있는 가상 웹 사이트에 누가 접근하고 있는지 식별하는 기능을 제공하지 않음
- 다른 요청이 서로 다른 웹 사이트에 있는 문서를 요청하더라도, 요청 자체가 똑같이 생겼고 호스트 정보가 요청에서 제거되면서 문제가 생길 수 있음

### 18.2.2 가상 호스팅 동작하게 하기

`URL 경로를 통한 가상 호스팅`

- 서버가 어떤 사이트를 요청하는 것인지 알 수 있게 URL에 특별한 경로 컴포넌트를 추가
- 불필요하고 혼란스러운 접두어가 생기므로 URL 기반의 가상 호스팅은 좋지 않은 방법이라 거의 사용되지 않음

`포트번호를 통한 가상 호스팅`

- 각 사이트에 다른 포트번호를 할당하여, 분리된 웹 서버의 인스턴스가 요청을 처리
- 사용자는 URL에 비표준 포트를 쓰지 않고서도 리소스를 찾길 원하기 때문에 같은 문제 존재

`IP 주소를 통한 가상 호스팅`

- 각 가상 사이트에 별도의 IP 주소를 할당하고 모든 IP 주소를 장비 하나에 연결, 웹 서버는 IP 주소로 사이트 이름을 식별
- IP 주소를 통한 가상 호스팅의 문제점
    - 컴퓨터 시스템이 연결할 수 있는 장비의 IP 개수 제한
    - IP 주소는 희소 상품으로 모든 웹 사이트에 할당할 가상 IP 주소를 충분히 얻지 못할 수 있음

`Host 헤더를 통한 가상 호스팅`

- 웹 서버는 Host 헤더로 가상 사이트를 식별
- 브라우저와 서버 개발자들은 서버가 원 호스트명을 받아 볼 수 있게 HTTP를 확장
- 대부분의 서버는 경로 컴포넌트만 받아 요청을 처리할 수 있기 때문에, 브라우저가 전체 URL 을 보내도 소용없음
- 대신 모든 요청에 호스트 명과 포트를 Host 확장 헤더에 기술해서 전달

### 18.2.3 HTTP/1.1 Host 헤더 

Host 헤더는 RFC 2068에 정의되어 있는 HTTP/1.1 요청 헤더입니다.

`문법과 사용 방법`

Host 헤더에는 원본 URL 에 있는 요청 리소스에 대한 인터넷 호스트와 포트번호를 기술합니다.

```
Host = "Host" ":"호스트[":"포트]
```

**규칙**

- Host 헤더에 포트가 기술되어 있지 않으면, 해당 스킴의 기본 포트를 사용 
- URL에 IP 주소가 있으면, Host 헤더는 같은 주소를 포함해야 함
- URL에 호스트 명이 기술되어 있으면, Host 헤더는 같은 호스트 명을 포함해야 함
- URL에 호스트 명이 기술되어 있으면, Host 헤더는 URL의 호스트 명이 가리키는 IP 주소를 포함해서는 안됨
- 클라이언트가 특정 프락시 서버를 사용한다면, Host 헤더에 프락시 서버가 아닌 원 서버의 호스트 명과 포트를 기술해야 함
- 웹 클라이언트는 모든 요청 메시지에 Host 헤더를 기술
- 웹 프락시는 요청을 전달하기 전에 요청 메시지에 Host 헤더를 추가해야 함
- HTTP/1.1 웹 서버는 Host 헤더 필드가 없는 HTTP/1.1 요청 메시지를 받으면 400 상태 코드로 응답해야 함

Host 헤더를 포함하여 요청하는 HTTP 메시지의 예
```
    GET http://www.joes-hardwre.com/index.html HTTP/1.0
    Connection: Keep-Alive
    User-Agent: Mozilla/4.51 [en] (X11; U; IRIX 6.2 IP22)
    Accept: image/gif, image/x-xbitmap, image/jpeg, image/png, */*
```

`Host 헤더의 누락`

**현재는 모든 주요 브라우저가 Host 헤더를 전송합니다.** 만약 Host 헤더가 존재하지 않는다면, 서버는 사용자를 기본 웹페이지로 보내거나 브라우저를 업그레이드하라고 제안하는 에러 페이지를 반환할 수 있습니다.

`Host 헤더 해석하기`

호스트를 기준으로 리소스를 구분하는 모든 웹 서버는 HTTP/1.1을 통해 오는 리소스를 결정하려면 아래와 같은 규칙을 사용해야 합니다.

1. HTTP 요청 메시지에 전체 URL (스킴, 호스트 포함) 이 기술되어 있으면, Host 헤더에 있는 값은 무시하고 URL을 사용
2. HTTP 요청 메시지에 있는 URL에 호스트 명이 기술되어 있지 않고 요청에 Host 헤더가 있으면, 호스트 명과 포트를 Host 헤더에서 가져옴
3. 1, 2단계에서 `호스트를 결정할 수 없으면` 클라이언트에 400 Bad Request 응답을 반환

`Host 헤더와 프락시`

어떤 브라우저 버전은 부정확한 Host 헤더를 보내는데, 특정 프락시를 사용하게 설정했을 때 그럴 수 있습니다.

## 18.3 안정적인 웹 사이트 만들기

`웹 사이트에 장애가 생기는 몇 가지 상황`이 있습니다.

- 서버 다운
- 트래픽 폭증: 갑자기 많은 사람이 특정 뉴스 방송을 보려고 하거나 할인 행사 때문에 몰려드는 상황
- 네트워크 장애나 손실

### 18.3.1 미러링 된 서버 팜

`서버 팜`은 서로 대신할 수 있고 식별할 수 있게 설정된 웹 서버들의 집합입니다. 서버 팜의 서버에 있는 콘텐츠들은 한 곳에 문제가 생기면 다른 한 곳에서 대신 전달할 수 있게 미러링이 가능합니다.

**특징**
- 원본 콘텐츠를 가지고 있는 `마스터 원 서버`, 미러링 된 서버는 `복제 원 서버`
- 미러링 된 서버는 다른 위치에 있는 콘텐츠와 정확히 같은 복제본 존재
- 네트워크 스위치를 사용하여 서버에 분산 요청을 전송, 서버에 호스팅 되고 있는 웹 사이트의 IP 주소는 스위치의 IP 주소가 됨
- 마스터 원 서버는 복제 원 서버에게 콘텐츠를 보낼 책임이 있고, 스위치는 서버에게 요청을 전송해야하는 책임이 있음

`HTTP 리다이렉션`

콘텐츠에 대한 URL은 마스터 서버의 IP를 가리키고, 마스터 서버는 요청을 받는 즉시 복제 서버로 리다이렉트시킵니다.

`DNS 리다이렉션`

콘텐츠의 URL은 네 개의 IP 주소를 가리킬 수 있고, DNS 서버는 클라이언트에게 전송할 IP 주소를 선택할 수 있습니다.

### 18.3.2 콘텐츠 분산 네트워크

`콘텐츠 분산 네트워크(CDN)`은 특정 콘텐츠의 분산을 목적으로 하는 단순 네트워크입니다. 네트워크의 노드는 서버, 대리 서버, 혹은 프락시 서버가 될 수 있습니다.

### 18.3.3 CDN의 대리 캐시

`대리 캐시`

- 리버스 프락시라고도 불리고, 미러링 된 웹 서버처럼 콘텐츠에 대한 요청을 받음
    - 원 서버와 대리 서버가 연결되며, 대리 서버는 특정 원 서버를 가리키는 요청을 받음

대리 서버와 미러링 된 서버의 차이점

- 대리 서버는 보통 수요에 따라서 동작
- 대리 서버는 원 서버의 전체 콘텐츠를 복사하지 않고, 클라이언트가 요청하는 콘텐츠만 저장
- 사용자가 요청하기도 전에 콘텐츠를 가져오는 '미리 가져오기' 기능을 가진 대리 서버도 존재
- CDN이 대리 서버보다 캐시를 계층화하기 더 어려움

### 18.3.4 CDN의 프락시 캐시

`프락시 캐시`

- 대리 서버를 이용한 프락시 캐시는 요청이 있을 때만 저장될 것이고, 원본 서버를 정확히 복제한다는 보장 없음
- 요청이 있을 때만 저장하는 프락시 캐시는 레이어2 혹은 레이어3 장비가 중간에서 웹 트래픽을 가로채 처리하기도 함
    - 가로채기 설정은 클라이언트와 서버 사이의 요청이 물리적으로 캐시를 거치게 네트워크 설정을 할 수 있는지에 따라 달라짐

## 18.4 웹 사이트 빠르게 만들기

웹 사이트 속도를 높이는 방법

- 서버 팜이나 분산 프락시 캐시나 대리 서버는 혼잡을 조절하고, 네트워크 트래픽을 분산 시킴
    - 분산시키면 전송하는 시간 단축
- 콘텐츠 인코딩
    - 클라이언트가 받은 압축을 해제할 수 있다는 가정하에, 콘텐츠를 압축