# 11장 클라이언트 식별과 쿠키

## 11.1 개인화

웹 서버는 요청을 보낸 사용자를 식별하거나 방문자가 보낸 연속적인 요청을 추적하기 위해 약간의 정보를 이용할 수 있습니다. 이러한 정보로 개인화된 서비스를 제공하고 싶어 합니다.

- 개인화
- 사용자 맞춤 추천
- 저장된 사용자 정보
- 세션 추적
    - 온라인 쇼핑 사이트의 장바구니 기능

위와 같은 서비스를 제공하기 위해 HTTP 는 사용자를 식별해야 했고, 이를 위해 사용하는 기술들에 대해서 정리합니다.

- 사용자 식별 관련 정보를 전달하는 HTTP 헤더들
- 클라이언트 IP 주소 추적으로 알아낸 IP 주소로 사용자 식별
- 사용자 로그인 인증을 통한 사용자 식별
- URL에 식별자를 포함하는 기술인 fat URL
- 식별 정보를 지속해서 유지하는 강력하면서도 효율적인 기술인 쿠키

## 11.2 HTTP 헤더

| 헤더 이름 | 헤더 타입 | 설명 |
|---|:---:|:---:|
| `From` | 요청 | 사용자의 이메일 주소 |
| `User-Agent` | 요청 | 사용자의 브라우저 |
| `Referer` | 요청 | 사용자가 현재 링크를 타고 온 근원 페이지 |
| `Authorization` | 요청 | 사용자 이름과 비밀번호 |
| `Client-ip` | 확장(요청) | 클라이언트 IP 주소 |
| `X-Forwarded-For` | 확장(요청) | 클라이언트 IP 주소 |
| `Cookie` | 확장(요청) | 서버가 생성한 ID 라벨 |

> From 헤더

사용자의 이메일 주소를 포함합니다. 악의적인 서버가 이메일 주소를 모아서 스팸 메일을 발송하는 문제가 있어서 From 헤더를 보내는 브라우저는 많지 않습니다.

> User-Agent 헤더

사용자가 쓰고 있는 브라우저 이름과 버전 정보, 운영체제에 대한 정보까지 포함

특정 브라우저에서 제대로 동작하도록 그것들의 속성에 맞추어 콘텐츠를 최적화하는 데 유용할 수 있지만, 특정 사용자를 식별하는 데는 큰 도움이 되지 않습니다.

크롬

```
Mozilla/5.0 (Windows NT 6.1) AppleWebkit/537.36 (KTHML, like Gecko) Chrome/38.0.2125.111 Safari/537.36
```

인터넷 익스플로러

```
Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)
```

> Referer 헤더

사용자가 현재 페이지로 유입하게 한 웹 페이지의 URL

## 11.3 클라이언트 IP 주소

클라이언트 IP 주소로 사용자를 식별하는 방식의 약점

- 클라이언트 IP 주소는 사용자가 아닌, 사용하는 컴퓨터를 가리키므로 여러 사용자가 같은 컴퓨터를 사용하면 무의미
- ISP는 사용자가 로그인하면 동적으로 IP 주소를 할당하므로 웹 서버는 사용자를 IP 주소로 식별 불가능
- 네트워크 주소 변환(NAT) 방화벽을 통해 인터넷을 사용하면 실제 IP 주소는 방화벽 뒤로 숨기때문에 식별 불가능
- 웹 서버는 클라이언트의 IP 주소 대신 프락시 서버의 IP 주소를 볼 가능성이 높아서 식별 불가능

## 11.4 사용자 로그인

웹 서버는 사용자 이름, 비밀번호로 인증할 것을 요구해서 사용자게에 명시적 식별 요청이 가능합니다.

- 브라우저는 https://github.com 사이트로 요청
- 사이트 접근 전, 로그인을 시키고자 한다면 HTTP 401 Unauthorized 응답 코드를 브라우저에 전송
- 브라우저는 사용자에게 로그인을 요구
- 클라이언트는 Authorization 헤더에 사용자의 인증 토큰을 기술하여 전송
- 서버는 사용자의 식별정보 얻었으므로 이후에 브라우저는 요청마다 토큰을 헤더에 담아 전송하면, 그 사용자에 대한 식별을 유지

## 11.5 fat URL

사용자의 상태 정보를 포함하고 있는 URL 을 ```fat URL``` 이라고 합니다. URL 경로의 처음이나 끝에 어떤 상태 정보를 추가하여 확장합니다.

fat URL은 사이트를 브라우징하는 사용자를 식별하는 데 사용할 수 있지만 이 기술에는 여러 심각한 문제가 있습니다.

- 브라우저에 보이는 fat URL은 새로운 사용자에게 혼란 야기
- fat URL을 누군가에게 보내면, 누적된 개인 정보를 본의 아니게 공유하게 됨
- URL 로 만드는 것은, URL 이 달라지기 때문에 기존 캐시에 접근할 수 없음
- 서버는 fat URL 에 해당하는 HTML 페이지를 다시 그려야함
- 사용자가 서비스를 사용하는 동안, 세션 정보가 추가된 fat URL을 사용해야만 문제없이 동작함
- 사용자가 특정 fat URL을 북마크하지 않는 이상, 로그아웃하면 모든 정보 유실

## 11.6 쿠키

```쿠키```는 사용자를 식별하고 세션을 유지하는 방식 중에서 가장 널리 사용하는 방식입니다. 넷스케이프가 최초로 개발했지만, 지금은 모든 브라우저에서 지원합니다.

### 11.6.1 쿠키의 타입 

> 세션 쿠키 (session cookie)

- 사용자가 브라우저를 닫으면 삭제됩니다.
- Max-Age, Expires 파라미터가 없으면 세션 쿠키

> 지속 쿠키 (persistent cookie)

- 브라우저를 닫아도 더 길게 유지됩니다.
- 디스크에 저장되어, 브라우저를 닫거나 컴퓨터를 재시작해도 남아있습니다.
- 주기적으로 방문하는 사이트에 대한 설정 정보 & 로그인 이름을 유지하려고 사용합니다.

### 11.6.3 쿠키: 클라이언트 측 상태

- 구글 크롬 쿠키: 각 브라우저는 각기 다른 방식으로 쿠키 저장, 구글 크롬은 Cookies라는 SQLite 파일에 쿠키를 저장
- creation_utc: 쿠키 생성된 시점, 초 단위로 기술
- host_key: 쿠키의 도메인
- name: 쿠키의 이름
- value: 쿠키의 값
- path: 쿠키와 관련된 도메인에 있는 경로
- expires_utc: 쿠키의 파기 시점, 초 단위로 기술
- is_secure: 이 쿠키를 SSL 커넥션일 경우에만 보낼지를 가리킨다.

### 11.6.4 사이트마다 각기 다른 쿠키들

브라우저는 보통 각 사이트에 두 개 혹은 세 개의 쿠키만을 보냅니다. 이유는 아래와 같습니다.

- 쿠키를 모두 전달하면 성능 저하
- 대부분 사이트에서는 인식하지 않는 무의미한 값
- 특정 사이트에서 제공한 정보를 신뢰하지 않는 사이트에서 가져갈 수 있으므로 잠재적인 개인정보 문제를 일으킬 가능성 높음

쿠키는 서버가 생성하여 클라이언트에 전달, 클라이언트는 쿠키를 유요한 사이트에만 전달하고 관리합니다.

**쿠키 Domain 속성**

서버가 쿠키를 생성할 때 Set-Cookie 응답 헤더에 Domain 속성을 추가하여 어떤 사이트가 쿠키를 읽을 수 있는지 제어할 수 있습니다.

아래는 github.com/sujin-park 사이트에 접근하게 되면 Cookie 헤더 적용에 대한 예시입니다.
```
Set-cookie: user="sujin"; domain="github.com/sujin-park"
```

**쿠키 Path 속성**

URL 앞 부분을 가리키는 Path 속성을 기술하여 웹 사이트 일부에만 쿠키를 적용할 수 있습니다.
```
Set-cookie: user="sujin"; domain="github.com" path="/sujin-park"
```


### 11.6.5 쿠키 구성요소

| Set-Cookie 속성 | 설명 및 용례 |
|---|:---:|
| `이름-값` | 필수 속성. $는 예약된 문자로 쿠키 이름은 $로 시작할 수 없음 |
| `Version` | 필수 속성. 쿠키 명세의 버전 |
| `Comment` | 선택 속성. 서버가 쿠키를 사용하려는 의도를 기술 |
| `Domain` | 선택 속성. 브라우저는 이 속성에 기술된 도메인에 해당하는 서버 호스트들에게만 쿠키를 전송 |
| `Max-Age` | 선택 속성. 쿠키의 생명주기를 초 단위로 산정한 정수 값 |
| `Path` | 선택 속성. 특정 문서에만 쿠키를 할당할 수 있음. |
| `Port` | 선택 속성. 쿠키가 적용될 포트 한 개 이상을 콤마로 구분하여 기술 |
| `Secure` | 선택 속성. HTTP가 SSL 보안 연결을 사용할 때만 쿠키가 전송 |

### 11.6.8 쿠키와 세션 추척

쿠키는 웹 사이트에 수차례 트랜잭션을 만들어내는 사용자를 추적하는 데 사용할 수 있습니다. 아래는 Amazon.com 에서 일련의 리다이렉트, 쿠키 설정 등 연속적인 트랜잭션에 대한 내용입니다.

- 브라우저가 Amazon.com 페이지를 요청
- 서버는 클라이언트를 전자상거래 소프트웨어 URL 로 리다이렉트
- 클라이언트는 리다이렉트 URL 로 요청
- 서버는 응답에 세션 쿠키를 기술하고 사용자를 다른 URL 로 리다이렉트 시키며, 클라이언트는 다시 쿠키를 첨부하여 요청
- 클라이언트는 새로운 URL을 쿠키와 함께 전송
- 서버는 home.html 페이지로 리다이렉트시키고 쿠키 두 개를 첨부
- 클라이언트는 home.html 페이지를 가져오고 총 네개의 쿠키 전달
- 서버는 콘텐츠 전송

### 11.6.9 쿠키와 캐싱

> 캐시되지 말아야 할 문서가 있다면 표시하라

문서가 Set-Cookie 헤더를 제외하고 캐시를 해야한다면 문서에 명시적으로 ```Cache-Control: no-cache="Set-Cookie"```를 기술해서 명확히 표시해야 합니다.

> Set-Cookie 헤더를 캐시하는 것에 유의하라

캐시가 모든 요청마다 원 서버와 재검사하여 클라ㅣ언트로 가는 응답에 Set-Cookie 헤더 값을 기술해서 문제를 개선할 수 있습니다.
```
Cache-Control: must-validate, max-age=0
```
> Cookie 헤더를 가지고 있는 요청을 주의하라

요청이 Cookie 헤더와 함께 오면, 콘텐츠가 개인정보를 담고 있을 수도 있다는 힌트입니다. Set-Cookie 가 있는 이미지에 대해서는 캐시를 하지만 Set-Cookie 가 있는 텍스트는 캐시를 하지 않는 캐시도 있을 수 있습니다.