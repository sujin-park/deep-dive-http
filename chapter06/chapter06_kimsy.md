## 6장 프록시

### 프록시의 역할
: 클라이언트와 웹서버 사이의 중개자 => 서버/클라이언틑 역할 모두 수행
+ 공용 프록시
  - 중앙집중형 관리 방식이 효율적 => 대부분 공용/공유해 사용
  - 공통 요청 처리 시 효율 증가
+ 개인 프록시
  - 주로 클라이언트PC에서 직접 실행 
  - 예) 브라우저 확장 기능
+ 게이트웨이와 차이점
  - 프록시는 동일 프로토콜로 통신
  - 게이트웨이는 여러 프로토콜 변환 ex) HTTP/POP 메일
  - but) 상용 프록시는 게이트웨이 기능 있어 차이 미미  

### 프록시의 기능
+ 보안 개선
  - 문서 접근제어
  - 보안 방화벽: 응용 레벨 프로토콜 통제/감시
+ 성능 증대
  - 대리 프록시(Surrogate)  
    : 웹 서버처럼 위장해 콘텐츠 검색 및 제공
  - 콘텐츠 라우터  
    : 트래픽 조건 및 콘텐츠 종류 따라 특정 서버로 유도 => 맞춤형 서비스
  - 트랜스코더  
    : 콘텐츠 전달 전 본문포맷 수정/압축/변환 가능   
+ 비용 절약
  - 프록시 캐시: 서버 접근 비용 불필요 
+ 트래픽 감시/수정
  - 어린이 필터: 필터링 프록시 이용해 성인콘텐츠 차단
  - 익명화 프록시(Anonymizer)  
    : HTTP메세지에서 신원식별정보(OS, From, Referer, Cookie) 제거해 익명성 보장  

### 프록시의 배치
|명칭|배치 위치|상세|
|---|---|---|
|출구 프록시 |LAN의 출구 |로컬 네트워크와 외부망 사이 트래픽 제어 가능 <br>ex) 방화벽, 인터넷 요금 절약, 어린이 필터 |
|접근(입구) 프록시 |ISP 접근 지점 |- ISP 사용자 요청 종합적 처리 가능 <br> - 캐시 이용해 속도 개선 및 비용 절감|
|대리(리버스) 프록시 |웹서버 바로 앞 |- 웹서버를 대리해 요청 처리 <br> - 필요시에만 웹서버 자원 요청 <br> - 보안 및 캐시 기능 추가 가능 |
|네트워크 교환 프록시 |네트워크 사이 <br> 인터넷 피어링 교환 지점 | 캐시 이용해 트랙픽 혼잡 완화 및 감시|

### 프록시의 구조
+ 프록시 계층  
  - 서버/클라이언트와의 상대적 거리에 따라 계층 구분
  - ex) 서버 -> 인바운드(부모) 프록시 -> 아웃바운드(자식) 프록시 -> 클라이언트
+ 유동적 라우팅  
  : 여러 조건/메세지에 따라 부모/캐시/압축 프록시나 원 서버에 라우팅  
  
  |조건|상세|
  |---|---|
  |부하 균형| 부모들의 작업량에 따라 선택|
  |지리적 인접성|원 서버의 지역 담당하는 부모 선택|
  |프로토콜/타입|프로토콜/URI에 따라 부모나 원서버로 라우팅|
  |유료 서비스 가입자|가입자인 경우 대형캐시/압축엔진으로 라우팅|
  
  * 부모 선택 로직은 설정/스크립트언어/플러그인 등에 따라 다르게 구현 

+ 트래픽 처리 
  : 클라이언트는 보통 웹서버와 직접 대화 => 프록시를 통하도록 만들어야

  |방법|상세|
  |---|---|
  |클라이언트 설정|클라이언트의 수동/자동 프록시 설정을 이용|
  |네트워크 설정|인터셉트 프록시를 이용해 네트워크의 웹트래픽을 가로채고 프록시로 전송|
  |DNS 이름공간 수정|DNS 이름 테이블을 편집하거나 동적 DNS서버를 이용해 모든 요청을 대리프록시로 전송|
  |웹서버 수정|HTTP 리다이렉션 명령(305코드) 이용해 프록시로 리다이렉트 가능|

### 클라이언트 프록시 설정
|방법|상세|
|---|---|
|수동 설정 |프록시 사용을 명시적으로 설정 |
|브라우저 기본 설정 |브라우저 벤더가 미리 프록시를 설정 |
|프록시 자동 설정 |자바스크립트 PAC(Proxy auto-config) 파일 참조해 프록시 사용여부 동적으로 판단|
|WPAD 프록시 |브라우저가 PAC URI 자동 검색하는 WPAD(web Proxy Autodiscovery) 프로토콜 제공|  

+ PAC함수
  - 함수명: FindProxyForUrl(url, host)
  - 반환문자열
    * DIRECT
    * PROXY host:port
    * SOCKS host:port

### 프록시 요청의 특징
+ 프록시 URI와 서버 URI의 차이
  - 서버 요청 시 스킴/호스트 생략된 URI 요청 사용 (HTTP/1.1 규약위반)
  - 프록시 요청 시 완전한 URI 요청 사용
+ 인터셉트/대리 프록시의 비가시성
  - 인터셉트/대리 프록시는 클라이언트가 인지 못함 => 불완전한 URI 전송됨 
+ URI 수정 규칙

  |URI 정보|수정방식|
  |---|---|
  |완전한 URI | 해당 URI 사용|
  |부분 URI + 호스트헤더 | 호스트 헤더 이용해 원서버 주소 찾기| 
  |부분 URI | - 대리프록시: 프록시 설정의 원서버 주소 참조 <br> - 지나온 인터셉트 프록시의 원서버 주소 정보 참조 <br> - 주소 참조 실패시 에러 반환|

  * 주의! 정규화하거나 규칙 엄한 경우 상호운용성 문제 발생 가능

+ URI 자동 완성 및 호스트명 확장 불가  
  : 프록시 없을 경우 입력내용을 바탕으로 URI 자동 확장 가능 (URI Resolution)
  - 접두사(www.)와 접미사(.com) 추가해 검색
  - 오타교정 및 URI 제시하는 서드파티에 전송
  - 현재 도메인 주소 이용해 확장 

### 메시지 추적
+ via 헤더
: 메세지가 지나는 중간 노드 정보 나열
  - 기능
    * 메세지 전달 추적 
    * 메세지 루프 진단 (unique 문자열 검사)  
      => 프록시는 unique 문자열을 헤더에 반드시 삽입해야 
    * 모든 노드의 프로토콜 처리 능력 테스트
  - 문법  
    : 콤마(,)로 구분된 각 Via waypoint는 최대 4개 구성요소 포함  
    ex) `Via: 1.1 proxy-62.ai-isp.com, 1.0 cache.wei-netware.com`

    |명칭|상세|비고|
    |---|---|--|
    |프로토콜명|중개자가 받은 프로토콜| 기본값: HTTP, 선택사항|
    |프로코톨 버전|표준 버전 번호 사용 <br> ex) 1.0, 1.1| 필수사항 |
    |노드이름|중개자의 호스트 및 포트 정보 (보안 위해 가명값 사용 가능)| 필수사항 |
    |노드코멘트|중개자 노드 서술 코멘트 <br> ex) 벤더, 버전정보, 이벤트 진단정보| 선택사항|

  - 규칙
    * 게이트웨이: 이용 시 프로토콜명 바뀌게 됨
    * Server 응답 헤더: 원 서버의 소프트웨어 정보이므로 수정하면 안 됨
    * 가명교체: 보안 유지 위해 한 조직 내의 경유지 항목은 하나로 합칠 수 있음

+ HTTP/1.1 TRACE 메소드
  - TRACE 응답 통해 프록시 서버 지나며 변경되는 메세지 관찰/추적 가능  
    * Content-Type: message/http
    * 상태코드: 200 
  - Max-Forwards  
    * 무한루프 방지 및 특정 프록시만 체크 시 이용 가능
    * 값이 0보다 크면 메세지 전달 시 1 감소된 값으로 갱신
+ 인증  
  - 상태코드 407(Proxy Authorization Requred) 반환해 접근자격 확인 가능
  - 주의! 널리 구현되지는 않은 기능

### 프록시 상호운용성
: 중개 시 여러 벤더/환경/버그 등에 대응 가능해야
+ 미지원 헤더/메서드 대응
  - 미지원 헤더도 반드시 전달
  - 헤더 간 상대적 순서 유지 필요
  - 미지원 메소드도 반드시 전달 (HTTP/1.1은 메소드 확장 허용)
+ OPTIONS 메소드
  - 서버/리소스의 지원 기능/메소드 확인 가능
  - 형식
    * 서버능력 확인: `OPTIONS * HTTP/1.1`
    * 특정 리소스 확인: `OPTIONS http://www.test.kr/index.do HTTP/1.1`
    * 응답: 가능한 기능 서술한 여러 헤더필드 + 200 OK 메세지 
+ Allow 헤더
  - 해당 서버/리소스의 지원 메소드 열거되는 헤더 필드
  - 지원 메소드 추천 위해 요청 메세지에서도 사용 가능 (지원 의무X)
  - ex) `Allow: GET, HEAD, PUT`
 